// Delegacje SaaS - Prisma Schema
// Polish business trip expense management system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ContractType {
  EMPLOYMENT        // umowa o pracę
  CIVIL_CONTRACT    // umowa zlecenie (dawniej MANDATE)
  B2B               // działalność gospodarcza
  OTHER             // inne
}

enum ProjectStatus {
  ACTIVE
  CLOSED
  DRAFT
}

enum TransactionCategory {
  FOOD
  TRANSPORT
  HOTEL
  PARKING
  FUEL
  OTHER
}

enum ReceiptProcessingStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum DuplicateConfidence {
  EXACT
  HIGH
  MEDIUM
  LOW
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // bcrypt hashed
  firstName String
  lastName  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Contract & tax settings
  contractType           ContractType @default(CIVIL_CONTRACT)
  voluntarySocialSecurity Boolean     @default(false)
  ppkEnabled             Boolean      @default(false)
  ppkPercentage          Float        @default(2.0) // 2% default employee contribution

  // CSV import settings (JSON stored as string)
  csvColumnMapping       String? // JSON: { date: 'column_name', amount: 'column_name', ... }
  csvClassificationRules String? // JSON: [{ keyword: 'string', category: 'CATEGORY' }]

  // Relations
  projects     Project[]
  transactions Transaction[]
  advances     Advance[]
  receipts     Receipt[]
  auditLogs    AuditLog[]

  @@index([email])
}

model Project {
  id        String        @id @default(cuid())
  userId    String
  name      String
  status    ProjectStatus @default(ACTIVE)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Trip dates
  startDatetime        DateTime
  plannedEndDatetime   DateTime?
  actualEndDatetime    DateTime?

  // Country & diet settings (snapshot at creation)
  countryCode          String    // ISO 3166-1 alpha-2
  countryName          String
  currency             String    // ISO 4217 (EUR, USD, PLN...)
  dietAmountSnapshot   Float     // daily diet amount in currency
  hotelLimitSnapshot   Float     // hotel limit per night in currency
  breakfastCount       Int       @default(0) // reduces diet by 25% per breakfast

  // Salary (stored encrypted as base64 AES)
  salaryBrutto         String?   // encrypted
  salaryNetto          String?   // encrypted

  // Tax law snapshot at project creation (JSON)
  taxSnapshotData      String?   // JSON: frozen tax rates

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  advances     Advance[]
  receipts     Receipt[]

  @@index([userId, status])
  @@index([userId, startDatetime])
}

model Transaction {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Transaction data
  date        DateTime
  description String
  amount      Float    // always in project currency
  currency    String   // ISO 4217
  category    TransactionCategory @default(OTHER)

  // Flags
  isPrivate           Boolean @default(false) // not charged to company
  excludedFromProject Boolean @default(false) // exclude from balance
  isDeleted           Boolean @default(false) // soft delete

  // Linked receipt (optional)
  receiptId String?

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  receipt Receipt? @relation(fields: [receiptId], references: [id])

  @@index([userId, projectId])
  @@index([userId, isDeleted])
  @@index([projectId, isDeleted])
}

model Advance {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  date        DateTime
  amount      Float
  currency    String
  description String?
  isDeleted   Boolean @default(false)

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId, projectId])
}

model Receipt {
  id        String   @id @default(cuid())
  userId    String
  projectId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // File metadata
  originalFilename String
  filePath         String  // relative: uploads/{userId}/{projectId}/{filename}
  mimeType         String
  fileSize         Int     // bytes

  // OCR results
  ocrText        String?
  ocrLanguage    String?  // detected language
  ocrConfidence  Float?   // 0-100

  // AI extracted data
  invoiceNumber  String?
  detectedDate   DateTime?
  detectedAmount Float?
  vendorName     String?
  currency       String?

  // Duplicate detection
  fingerprint    String?  // SHA-256 hash for dedup
  isDuplicate    Boolean  @default(false)
  duplicateOfId  String?  // reference to original if duplicate

  // Processing
  processingStatus ReceiptProcessingStatus @default(PENDING)
  processingError  String?

  // Relations
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  project      Project?      @relation(fields: [projectId], references: [id])
  transactions Transaction[]

  @@index([userId, projectId])
  @@index([fingerprint])
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  createdAt DateTime @default(now())

  action     String  // CREATE, UPDATE, DELETE, LOGIN, LOGOUT...
  entityType String  // Project, Transaction, Receipt...
  entityId   String?
  metadata   String? // JSON additional data
  ipAddress  String?
  userAgent  String?

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([entityType, entityId])
}
