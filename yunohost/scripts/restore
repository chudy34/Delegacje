#!/bin/bash
# YunoHost restore script for Delegacje SaaS
# shellcheck disable=SC2034

source _common.sh
source /usr/share/yunohost/helpers

# ── Install Node.js 20 ───────────────────────
ynh_exec_warn_less curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
ynh_package_install nodejs

# ── Restore PostgreSQL ────────────────────────
ynh_psql_setup_db --db_user="$app" --db_name="$app" --db_pwd="$db_pwd"
ynh_psql_execute_file_as_root --file="./db.sql" --database="$app"

# ── Restore install_dir ───────────────────────
ynh_restore_file --origin_path="$install_dir"
chown -R "$app:$app" "$install_dir"

# ── Restore data_dir ─────────────────────────
ynh_restore_file --origin_path="$data_dir"
chown -R "$app:$app" "$data_dir"

# ── Restore nginx and systemd ─────────────────
ynh_restore_file --origin_path="/etc/nginx/conf.d/$domain.d/$app.conf"
ynh_restore_file --origin_path="/etc/systemd/system/${app}-backend.service"
ynh_restore_file --origin_path="/etc/systemd/system/${app}-frontend.service"

# ── Reload daemon and start ───────────────────
systemctl daemon-reload
ynh_systemd_action --service_name="${app}-backend" --action="start" --log_path="$data_dir/logs/backend.log"
ynh_systemd_action --service_name="${app}-frontend" --action="start"

ynh_add_nginx_config

ynh_print_info "Delegacje SaaS restored successfully."
