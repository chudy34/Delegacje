#!/bin/bash
# YunoHost upgrade script for Delegacje SaaS
# shellcheck disable=SC2034

source _common.sh
source /usr/share/yunohost/helpers

# ── Stop services during upgrade ─────────────
ynh_systemd_action --service_name="${app}-backend" --action="stop"
ynh_systemd_action --service_name="${app}-frontend" --action="stop"

# ── Copy new source ──────────────────────────
cp -r "../conf/app/." "$install_dir/"
chown -R "$app:$app" "$install_dir"

# ── Re-read settings ─────────────────────────
jwt_secret=$(ynh_app_setting_get --app="$app" --key="jwt_secret")
encryption_key=$(ynh_app_setting_get --app="$app" --key="encryption_key")
db_pwd=$(ynh_app_setting_get --app="$app" --key="db_pwd")
ai_provider=$(ynh_app_setting_get --app="$app" --key="ai_provider")
gemini_api_key=$(ynh_app_setting_get --app="$app" --key="gemini_api_key")

# ── Backend upgrade ──────────────────────────
pushd "$install_dir/backend"
    ynh_exec_as "$app" npm ci --only=production
    ynh_exec_as "$app" npx prisma generate

    # Update .env
    cat > .env << EOF
NODE_ENV=production
PORT=$port_backend
DATABASE_URL=postgresql://$app:$db_pwd@localhost:5432/$app
JWT_SECRET=$jwt_secret
JWT_EXPIRES_IN=7d
ENCRYPTION_KEY=$encryption_key
CORS_ORIGIN=https://$domain$path
AI_PROVIDER=$ai_provider
GEMINI_API_KEY=$gemini_api_key
UPLOAD_DIR=$data_dir/uploads
LOG_DIR=$data_dir/logs
EOF

    # Run migrations (safe to run multiple times)
    ynh_exec_as "$app" npx prisma migrate deploy

    ynh_exec_as "$app" npm run build
popd

# ── Frontend upgrade ─────────────────────────
pushd "$install_dir/frontend"
    ynh_exec_as "$app" npm ci

    cat > .env.production << EOF
NEXT_PUBLIC_API_URL=https://$domain$path
PORT=$port_frontend
NODE_ENV=production
EOF

    ynh_exec_as "$app" npm run build
popd

# ── Update systemd & nginx ───────────────────
ynh_add_systemd_config --service="${app}-backend" --template="backend.service"
ynh_add_systemd_config --service="${app}-frontend" --template="frontend.service"
ynh_add_nginx_config

# ── Restart services ─────────────────────────
ynh_systemd_action --service_name="${app}-backend" --action="start" --log_path="$data_dir/logs/backend.log"
ynh_systemd_action --service_name="${app}-frontend" --action="start"

ynh_print_info "Delegacje SaaS upgraded successfully!"
